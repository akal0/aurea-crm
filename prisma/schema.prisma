
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String       @id
  name          String
  email         String
  emailVerified Boolean      @default(false)
  image         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]
  workflows     Workflows[]
  credentials   Credential[]
  integrations  Integration[]
  webhooks      Webhook[]
  googleCalendarSubscriptions GoogleCalendarSubscription[]
  gmailSubscriptions          GmailSubscription[]

  members     Member[]
  invitations Invitation[]
  subaccounts Subaccount[]
  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeOrganizationId String?
  activeSubaccountId   String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

enum IntegrationProvider {
  GOOGLE_CALENDAR
  GMAIL
  GOOGLE
  TELEGRAM
  WHATSAPP
}

model Integration {
  id        String @id @default(cuid())
  provider  IntegrationProvider
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  scopes       String[]
  metadata     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider], name: "userId_provider")
}

model GoogleCalendarSubscription {
  id           String   @id @default(cuid())
  userId       String
  workflowId   String
  nodeId       String
  calendarId   String
  calendarName String?
  listenFor    String[]
  channelId    String
  resourceId   String
  webhookToken String
  syncToken    String?
  expiresAt    DateTime?
  lastSyncedAt DateTime?
  timezone     String?
  variableName String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflow Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  node     Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([nodeId])
  @@index([workflowId])
  @@index([channelId])
}

model GmailSubscription {
  id           String   @id @default(cuid())
  userId       String   @unique
  emailAddress String
  labelIds     String[]
  topicName    String
  historyId    String?
  expiresAt    DateTime?
  lastSyncedAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([emailAddress])
}

model GmailTriggerState {
  id              String   @id @default(cuid())
  nodeId          String   @unique
  workflowId      String
  lastMessageId   String?
  lastTriggeredAt DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  node     Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  workflow Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

model TelegramTriggerState {
  id              String   @id @default(cuid())
  nodeId          String   @unique
  workflowId      String
  lastUpdateId    String?
  lastTriggeredAt DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  node     Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  workflow Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

model WhatsAppTriggerState {
  id              String   @id @default(cuid())
  nodeId          String   @unique
  workflowId      String
  lastMessageId   String?
  lastTriggeredAt DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  node     Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  workflow Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

enum CredentialType {
  ANTHROPIC
  GEMINI
  OPENAI
  TELEGRAM_BOT
}

enum WebhookProvider {
  SLACK
  DISCORD
  STRIPE
  CUSTOM
}

model Credential {
  id        String         @id @default(cuid())
  name      String
  value     String
  type      CredentialType
  metadata  Json?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  subaccountId String?
  subaccount   Subaccount? @relation(fields: [subaccountId], references: [id], onDelete: SetNull)

  Node Node[]

  @@index([subaccountId])
}

model Webhook {
  id          String          @id @default(cuid())
  name        String
  provider    WebhookProvider
  url         String
  signingSecret String?
  description String?
  metadata    Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  subaccountId String?
  subaccount   Subaccount? @relation(fields: [subaccountId], references: [id], onDelete: SetNull)

  @@index([subaccountId])
}

model Workflows {
  id   String @id @default(cuid())
  name String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  archived   Boolean @default(false)
  isTemplate Boolean @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  subaccountId String?
  subaccount   Subaccount? @relation(fields: [subaccountId], references: [id], onDelete: SetNull)

  nodes       Node[]
  connections Connection[]
  executions  Execution[]
  googleCalendarSubscriptions GoogleCalendarSubscription[]
  gmailTriggerStates          GmailTriggerState[]
  telegramTriggerStates       TelegramTriggerState[]
  whatsappTriggerStates       WhatsAppTriggerState[]
  @@index([subaccountId])
}

enum NodeType {
  INITIAL
  MANUAL_TRIGGER
  GOOGLE_FORM_TRIGGER
  GOOGLE_CALENDAR_TRIGGER
  GOOGLE_CALENDAR_EXECUTION
  GMAIL_TRIGGER
  GMAIL_EXECUTION
  TELEGRAM_TRIGGER
  TELEGRAM_EXECUTION
  WHATSAPP_TRIGGER
  WHATSAPP_EXECUTION
  STRIPE_TRIGGER
  HTTP_REQUEST
  GEMINI
  ANTHROPIC
  OPENAI
  DISCORD
  SLACK
}

model Node {
  id String @id @default(cuid())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name     String
  type     NodeType
  position Json
  data     Json     @default("{}")

  outputConnections Connection[] @relation("FromNode")
  inputConnections  Connection[] @relation("ToNode")

  workflowId String
  workflow   Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  credentialId String?
  credential   Credential? @relation(fields: [credentialId], references: [id])

  googleCalendarSubscription GoogleCalendarSubscription?
  gmailTriggerState          GmailTriggerState?
  telegramTriggerState       TelegramTriggerState?
  whatsappTriggerState       WhatsAppTriggerState?
}

model Connection {
  id String @id @default(cuid())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fromNodeId String
  fromNode   Node   @relation("FromNode", fields: [fromNodeId], references: [id], onDelete: Cascade)

  toNodeId String
  toNode   Node   @relation("ToNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  fromOutput String @default("main")
  toInput    String @default("main")

  workflowId String
  workflow   Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([fromNodeId, toNodeId, fromOutput, toInput])
}

enum ExecutionStatus {
  RUNNING
  SUCCESS
  FAILED
}

model Execution {
  id String @id @default(cuid())

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  status     ExecutionStatus @default(RUNNING)
  error      String?         @db.Text
  errorStack String?         @db.Text

  inngestEventId String @unique

  output Json?

  workflowId String
  workflow   Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  subaccountId String?
  subaccount   Subaccount? @relation(fields: [subaccountId], references: [id], onDelete: SetNull)

  @@index([subaccountId])
}

model Organization {
  id          String       @id
  name        String
  slug        String
  logo        String?
  createdAt   DateTime
  metadata    String?
  members     Member[]
  invitations Invitation[]
  subaccounts Subaccount[]  

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

model Subaccount {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  logo        String?
  slug String?

  // Basic company profile
  companyName     String
  website         String?
  billingEmail    String?
  phone           String?
  addressLine1    String?
  addressLine2    String?
  city            String?
  state           String?
  postalCode      String?
  country         String?
  timezone        String?      @default("UTC")
  industry        String?

  // Admin/creator
  createdByUserId String?
  createdBy       User?        @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  workflows   Workflows[]
  credentials Credential[]
  webhooks    Webhook[]
  executions  Execution[]

  @@map("subaccount")
  @@index([organizationId])
}
