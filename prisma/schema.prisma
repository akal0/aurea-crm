
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ONLINE
  WORKING
  DO_NOT_DISTURB
  AWAY
  OFFLINE
}

model User {
  id            String       @id
  name          String
  email         String
  emailVerified Boolean      @default(false)
  image         String?
  status        UserStatus   @default(ONLINE)
  statusMessage String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]
  workflows     Workflows[]
  credentials   Credential[]
  apps  Apps[]
  webhooks      Webhook[]

  googleCalendarSubscriptions GoogleCalendarSubscription[]
  gmailSubscriptions          GmailSubscription[]
  outlookSubscriptions        OutlookSubscription[]
  oneDriveSubscriptions       OneDriveSubscription[]

  members     Member[]
  subaccountMemberships SubaccountMember[]
  invitations Invitation[]
  subaccounts Subaccount[]
  aiLogs      AILog[]

  // Notifications
  notifications         Notification[]
  notificationsAsActor  Notification[] @relation("NotificationActor")
  presence              UserPresence?
  notificationPreference NotificationPreference?

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeOrganizationId String?
  activeSubaccountId   String?

  // Activity tracking
  lastActivityAt DateTime? @default(now())
  isOnline       Boolean   @default(true)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

enum AppProvider {
  GOOGLE_CALENDAR
  GMAIL
  GOOGLE
  TELEGRAM
  MICROSOFT
  OUTLOOK
  ONEDRIVE
}

model Apps {
  id        String @id @default(cuid())
  provider  AppProvider
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  scopes       String[]
  metadata     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider], name: "userId_provider")
}

model GoogleCalendarSubscription {
  id           String   @id @default(cuid())
  userId       String
  workflowId   String
  nodeId       String
  calendarId   String
  calendarName String?
  listenFor    String[]
  channelId    String
  resourceId   String
  webhookToken String
  syncToken    String?
  expiresAt    DateTime?
  lastSyncedAt DateTime?
  timezone     String?
  variableName String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflow Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  node     Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([nodeId])
  @@index([workflowId])
  @@index([channelId])
}

model GmailSubscription {
  id           String   @id @default(cuid())
  userId       String   @unique
  emailAddress String
  labelIds     String[]
  topicName    String
  historyId    String?
  expiresAt    DateTime?
  lastSyncedAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([emailAddress])
}

model GmailTriggerState {
  id              String   @id @default(cuid())
  nodeId          String   @unique
  workflowId      String
  lastMessageId   String?
  lastTriggeredAt DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  node     Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  workflow Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

model TelegramTriggerState {
  id              String   @id @default(cuid())
  nodeId          String   @unique
  workflowId      String
  lastUpdateId    String?
  lastTriggeredAt DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  node     Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  workflow Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

model OutlookSubscription {
  id             String    @id @default(cuid())
  userId         String    @unique
  emailAddress   String
  subscriptionId String?
  expiresAt      DateTime?
  lastSyncedAt   DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([emailAddress])
}

model OutlookTriggerState {
  id              String    @id @default(cuid())
  nodeId          String    @unique
  workflowId      String
  lastMessageId   String?
  lastTriggeredAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  node     Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  workflow Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

model OneDriveSubscription {
  id             String    @id @default(cuid())
  userId         String    @unique
  subscriptionId String?
  expiresAt      DateTime?
  lastSyncedAt   DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OneDriveTriggerState {
  id              String    @id @default(cuid())
  nodeId          String    @unique
  workflowId      String
  lastDeltaLink   String?
  lastTriggeredAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  node     Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  workflow Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

enum CredentialType {
  ANTHROPIC
  GEMINI
  OPENAI
  TELEGRAM_BOT
}

enum WebhookProvider {
  SLACK
  DISCORD
  STRIPE
  CUSTOM
}

model Credential {
  id        String         @id @default(cuid())
  name      String
  value     String
  type      CredentialType
  metadata  Json?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  subaccountId String?
  subaccount   Subaccount? @relation(fields: [subaccountId], references: [id], onDelete: SetNull)

  Node Node[]

  @@index([subaccountId])
}

model Webhook {
  id          String          @id @default(cuid())
  name        String
  provider    WebhookProvider
  url         String
  signingSecret String?
  description String?
  metadata    Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  subaccountId String?
  subaccount   Subaccount? @relation(fields: [subaccountId], references: [id], onDelete: SetNull)

  @@index([subaccountId])
}

model Workflows {
  id   String @id @default(cuid())
  name String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  archived   Boolean @default(false)
  isTemplate Boolean @default(false)

  // Bundle workflow configuration
  isBundle Boolean @default(false)
  bundleInputs Json? // Define input parameters for bundle workflows
  bundleOutputs Json? // Define output parameters for bundle workflows

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  subaccountId String?
  subaccount   Subaccount? @relation(fields: [subaccountId], references: [id], onDelete: SetNull)

  nodes       Node[]
  connections Connection[]
  executions  Execution[]
  googleCalendarSubscriptions GoogleCalendarSubscription[]
  gmailTriggerStates          GmailTriggerState[]
  telegramTriggerStates       TelegramTriggerState[]
  outlookTriggerStates        OutlookTriggerState[]
  oneDriveTriggerStates       OneDriveTriggerState[]
  @@index([organizationId])
  @@index([subaccountId])
  @@index([isBundle])
}

enum NodeType {
  INITIAL
  MANUAL_TRIGGER
  GOOGLE_FORM_TRIGGER
  GOOGLE_CALENDAR_TRIGGER
  GOOGLE_CALENDAR_EXECUTION
  GMAIL_TRIGGER
  GMAIL_EXECUTION
  TELEGRAM_TRIGGER
  TELEGRAM_EXECUTION
  STRIPE_TRIGGER
  HTTP_REQUEST
  GEMINI
  ANTHROPIC
  OPENAI
  DISCORD
  SLACK
  WAIT
  CREATE_CONTACT
  UPDATE_CONTACT
  DELETE_CONTACT
  CREATE_DEAL
  UPDATE_DEAL
  DELETE_DEAL
  UPDATE_PIPELINE
  CONTACT_CREATED_TRIGGER
  CONTACT_UPDATED_TRIGGER
  CONTACT_FIELD_CHANGED_TRIGGER
  CONTACT_DELETED_TRIGGER
  CONTACT_TYPE_CHANGED_TRIGGER
  CONTACT_LIFECYCLE_STAGE_CHANGED_TRIGGER
  // Logic Nodes
  IF_ELSE
  SWITCH
  LOOP
  SET_VARIABLE
  STOP_WORKFLOW
  // Bundle Workflow
  BUNDLE_WORKFLOW
  // Microsoft Integration
  OUTLOOK_TRIGGER
  OUTLOOK_EXECUTION
  ONEDRIVE_TRIGGER
  ONEDRIVE_EXECUTION
}

model Node {
  id String @id @default(cuid())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name     String
  type     NodeType
  position Json
  data     Json     @default("{}")

  outputConnections Connection[] @relation("FromNode")
  inputConnections  Connection[] @relation("ToNode")

  workflowId String
  workflow   Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  credentialId String?
  credential   Credential? @relation(fields: [credentialId], references: [id])

  googleCalendarSubscription GoogleCalendarSubscription?
  gmailTriggerState          GmailTriggerState?
  telegramTriggerState       TelegramTriggerState?
  outlookTriggerState        OutlookTriggerState?
  oneDriveTriggerState       OneDriveTriggerState?
}

model Connection {
  id String @id @default(cuid())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fromNodeId String
  fromNode   Node   @relation("FromNode", fields: [fromNodeId], references: [id], onDelete: Cascade)

  toNodeId String
  toNode   Node   @relation("ToNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  fromOutput String @default("main")
  toInput    String @default("main")

  workflowId String
  workflow   Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([fromNodeId, toNodeId, fromOutput, toInput])
}

enum ExecutionStatus {
  RUNNING
  SUCCESS
  FAILED
}

enum AILogStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model AILog {
  id String @id @default(cuid())

  title       String
  description String?
  intent      String?
  userMessage String   @db.Text
  status      AILogStatus @default(RUNNING)

  error      String? @db.Text
  result     Json?

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  subaccountId String?
  subaccount   Subaccount? @relation(fields: [subaccountId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([organizationId])
  @@index([subaccountId])
}

model Execution {
  id String @id @default(cuid())

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  status     ExecutionStatus @default(RUNNING)
  error      String?         @db.Text
  errorStack String?         @db.Text

  inngestEventId String @unique

  output Json?

  workflowId String
  workflow   Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  subaccountId String?
  subaccount   Subaccount? @relation(fields: [subaccountId], references: [id], onDelete: SetNull)

  @@index([subaccountId])
}

model Organization {
  id          String       @id
  name        String
  slug        String
  logo        String?
  createdAt   DateTime
  metadata    String?
  members     Member[]
  invitations Invitation[]
  subaccounts Subaccount[]
  contacts    Contact[]
  deals       Deal[]
  pipelines   Pipeline[]
  workflows   Workflows[]
  aiLogs      AILog[]
  modules     SubaccountModule[]

  @@unique([slug])
  @@map("organization")
}

enum OrganizationMemberRole {
  owner
  admin
  manager
  staff
  viewer
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           OrganizationMemberRole      @default(viewer)
  createdAt      DateTime

  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

model Subaccount {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  logo        String?
  slug String?

  // Basic company profile
  companyName     String
  website         String?
  billingEmail    String?
  phone           String?
  addressLine1    String?
  addressLine2    String?
  city            String?
  state           String?
  postalCode      String?
  country         String?
  timezone        String?      @default("UTC")
  industry        String?

  // Admin/creator
  createdByUserId String?
  createdBy       User?        @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  workflows   Workflows[]
  credentials Credential[]
  webhooks    Webhook[]
  executions  Execution[]
  members     SubaccountMember[]
  contacts    Contact[]
  deals       Deal[]
  pipelines   Pipeline[]
  aiLogs      AILog[]

  // Modules
  modules     SubaccountModule[]
  timeLogs    TimeLog[]
  qrCodes     QRCode[]
  workers     Worker[]

  @@map("subaccount")
  @@index([organizationId])
}

enum SubaccountMemberRole {
  AGENCY
  ADMIN
  MANAGER
  STANDARD
  LIMITED
  VIEWER
}

model SubaccountMember {
  id           String      @id @default(cuid())
  subaccountId String
  subaccount   Subaccount  @relation(fields: [subaccountId], references: [id], onDelete: Cascade)
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  role         SubaccountMemberRole      @default(STANDARD)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  contactAssignees ContactAssignee[]
  dealMembers DealMember[]

  @@unique([subaccountId, userId])
  @@map("subaccount_member")
}

enum ContactType {
  LEAD
  PROSPECT
  CUSTOMER
  CHURN
  CLOSED
}

enum LifecycleStage {
  SUBSCRIBER
  LEAD
  MQL
  SQL
  OPPORTUNITY
  CUSTOMER
  EVANGELIST
}

model Contact {
  id               String        @id @default(cuid())
  organizationId   String
  organization     Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subaccountId     String?
  subaccount       Subaccount?   @relation(fields: [subaccountId], references: [id], onDelete: SetNull)
  logo             String?
  name             String
  companyName      String?
  email            String?
  position         String?
  phone            String?
  country          String?
  city             String?
  score            Int?          @default(0)
  type             ContactType   @default(LEAD)
  lifecycleStage   LifecycleStage?
  source           String?
  website          String?
  linkedin         String?
  tags             String[]      @default([])
  lastInteractionAt DateTime?
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  assignees        ContactAssignee[]
  deals            DealContact[]
  timeLogs         TimeLog[]

  @@index([organizationId, subaccountId])
  @@index([subaccountId, email])
  @@map("contact")
}

model ContactAssignee {
  id                  String           @id @default(cuid())
  contactId           String
  contact             Contact          @relation(fields: [contactId], references: [id], onDelete: Cascade)
  subaccountMemberId  String
  subaccountMember    SubaccountMember @relation(fields: [subaccountMemberId], references: [id], onDelete: Cascade)
  assignedAt          DateTime         @default(now())

  @@unique([contactId, subaccountMemberId])
  @@map("contact_assignee")
}

model Deal {
  id               String         @id @default(cuid())
  organizationId   String
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subaccountId     String?
  subaccount       Subaccount?    @relation(fields: [subaccountId], references: [id], onDelete: SetNull)
  pipelineId       String?
  pipeline         Pipeline?      @relation(fields: [pipelineId], references: [id], onDelete: SetNull)
  pipelineStageId  String?
  pipelineStage    PipelineStage? @relation(fields: [pipelineStageId], references: [id], onDelete: SetNull)
  name             String
  value            Decimal?       @db.Decimal(12, 2)
  currency         String?        @default("USD")
  deadline         DateTime?
  source           String?
  tags             String[]       @default([])
  description      String?
  lastActivityAt   DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  members  DealMember[]
  contacts DealContact[]
  timeLogs TimeLog[]

  @@index([organizationId, subaccountId])
  @@index([subaccountId, pipelineStageId])
  @@index([pipelineId])
  @@map("deal")
}

model DealMember {
  id                 String           @id @default(cuid())
  dealId             String
  deal               Deal             @relation(fields: [dealId], references: [id], onDelete: Cascade)
  subaccountMemberId String
  subaccountMember   SubaccountMember @relation(fields: [subaccountMemberId], references: [id], onDelete: Cascade)
  assignedAt         DateTime         @default(now())

  @@unique([dealId, subaccountMemberId])
  @@map("deal_member")
}

model DealContact {
  id        String   @id @default(cuid())
  dealId    String
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  contactId String
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([dealId, contactId])
  @@map("deal_contact")
}

model Pipeline {
  id             String          @id @default(cuid())
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subaccountId   String?
  subaccount     Subaccount?     @relation(fields: [subaccountId], references: [id], onDelete: SetNull)
  name           String
  description  String?
  isActive     Boolean         @default(true)
  isDefault    Boolean         @default(false)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  stages PipelineStage[]
  deals  Deal[]

  @@index([organizationId, subaccountId])
  @@index([subaccountId, isActive])
  @@map("pipeline")
}

model PipelineStage {
  id           String   @id @default(cuid())
  pipelineId   String
  pipeline     Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  name         String
  position     Int
  probability  Int      @default(0) // 0-100 percentage for forecasting
  rottingDays  Int?     // Days before deal is considered stale
  color        String?  // Hex color for visual differentiation
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  deals Deal[]

  @@unique([pipelineId, position])
  @@index([pipelineId])
  @@map("pipeline_stage")
}

model Notification {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Context
  organizationId String?
  subaccountId   String?

  // Notification content
  type           String    // WORKFLOW_CREATED, CONTACT_UPDATED, etc.
  title          String
  message        String
  data           Json?     // Additional metadata

  // Entity reference
  entityType     String?   // workflow, contact, deal, pipeline, invitation
  entityId       String?

  // Actor (who performed the action)
  actorId        String?
  actor          User?     @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)

  // Read status
  read           Boolean   @default(false)
  readAt         DateTime?

  createdAt      DateTime  @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([organizationId])
  @@index([subaccountId])
  @@map("notification")
}

model UserPresence {
  id             String    @id @default(cuid())
  userId         String    @unique
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Context
  organizationId String?
  subaccountId   String?

  // Presence data
  status         String    @default("offline") // online, offline, away
  lastSeenAt     DateTime  @default(now())
  lastActivityAt DateTime  @default(now())

  // Session info
  userAgent      String?
  ipAddress      String?

  updatedAt      DateTime  @updatedAt

  @@index([userId, status])
  @@index([organizationId])
  @@index([subaccountId])
  @@map("user_presence")
}

model NotificationPreference {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification type preferences (JSON object with type: boolean)
  preferences Json @default("{}")

  // Email notification preferences
  emailEnabled Boolean @default(true)
  emailDigest  Boolean @default(false) // Daily digest instead of instant

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_preference")
}

// ============================================================================
// MODULE SYSTEM
// ============================================================================

enum ModuleType {
  TIME_TRACKING
  INVOICING
  INVENTORY
  BOOKING_CALENDAR
  DOCUMENT_SIGNING
  PROJECT_MANAGEMENT
}

model SubaccountModule {
  id            String      @id @default(cuid())

  // Can be scoped to either organization or subaccount
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  subaccountId  String?
  subaccount    Subaccount?  @relation(fields: [subaccountId], references: [id], onDelete: Cascade)

  moduleType    ModuleType
  enabled       Boolean     @default(false)
  config        Json?       // Module-specific configuration

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([organizationId, moduleType])
  @@unique([subaccountId, moduleType])
  @@index([organizationId, enabled])
  @@index([subaccountId, enabled])
  @@map("subaccount_module")
}

// ============================================================================
// TIME TRACKING MODULE
// ============================================================================

enum CheckInMethod {
  MANUAL
  QR_CODE
  GPS
  BIOMETRIC
  NFC
}

enum TimeLogStatus {
  DRAFT        // Clock-in recorded, not yet clocked out
  SUBMITTED    // Clock-out completed
  APPROVED     // Manager approved
  REJECTED     // Manager rejected
  INVOICED     // Included in an invoice
}

model TimeLog {
  id            String      @id @default(cuid())
  subaccountId  String
  subaccount    Subaccount  @relation(fields: [subaccountId], references: [id], onDelete: Cascade)

  // Worker association (separate from CRM contacts)
  workerId      String?
  worker        Worker?     @relation(fields: [workerId], references: [id], onDelete: SetNull)

  // Legacy: Keep contactId for backwards compatibility (will be migrated)
  contactId     String?
  contact       Contact?    @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Job/Shift/Project association
  dealId        String?
  deal          Deal?       @relation(fields: [dealId], references: [id], onDelete: SetNull)

  // Time data
  startTime     DateTime
  endTime       DateTime?
  duration      Int?        // Duration in minutes (calculated)
  breakDuration Int?        // Break time in minutes

  // Location & check-in method
  checkInMethod   CheckInMethod  @default(MANUAL)
  checkInLocation Json?          // { lat: number, lng: number, address?: string }
  checkOutLocation Json?         // { lat: number, lng: number, address?: string }
  qrCodeId        String?        // If checked in via QR code

  // Work details
  title           String?        // e.g., "Morning Shift", "Client Site Visit"
  description     String?        // Notes about the work done
  status          TimeLogStatus  @default(DRAFT)

  // Billing
  billable        Boolean        @default(true)
  hourlyRate      Decimal?       @db.Decimal(10, 2)
  totalAmount     Decimal?       @db.Decimal(12, 2)
  currency        String?        @default("USD")

  // Approval workflow
  submittedAt     DateTime?
  submittedBy     String?        // UserId who submitted (could be worker or admin)
  approvedAt      DateTime?
  approvedBy      String?        // UserId who approved
  rejectedAt      DateTime?
  rejectedBy      String?        // UserId who rejected
  rejectionReason String?

  // Invoice linking
  invoiceId       String?        // Will be added when invoice module is built

  // Custom fields (for industry-specific data)
  customFields    Json?

  // Metadata
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([subaccountId, workerId])
  @@index([subaccountId, contactId])
  @@index([subaccountId, dealId])
  @@index([subaccountId, status])
  @@index([subaccountId, startTime])
  @@map("time_log")
}

// QR Code for quick check-ins at specific locations/sites
model QRCode {
  id            String      @id @default(cuid())
  subaccountId  String
  subaccount    Subaccount  @relation(fields: [subaccountId], references: [id], onDelete: Cascade)

  name          String      // e.g., "Warehouse A", "Client Site - Downtown"
  code          String      @unique // The actual QR code value (UUID)

  // Optional associations
  dealId        String?     // Associate QR with a specific job/site
  location      Json?       // { lat, lng, address }

  enabled       Boolean     @default(true)
  expiresAt     DateTime?   // Optional expiration

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([subaccountId])
  @@index([code])
  @@map("qr_code")
}

// Worker - Separate from CRM users, for time tracking portal
model Worker {
  id              String      @id @default(cuid())
  subaccountId    String
  subaccount      Subaccount  @relation(fields: [subaccountId], references: [id], onDelete: Cascade)

  // Basic info
  name            String
  email           String?
  phone           String?
  employeeId      String?     // Optional employee/reference number

  // Portal authentication
  portalToken     String?     @unique // Hashed magic link token
  portalTokenExpiry DateTime? // Token expiration
  lastLoginAt     DateTime?

  // Worker details
  hourlyRate      Decimal?    @db.Decimal(10, 2)
  currency        String?     @default("USD")
  role            String?     // e.g., "Carer", "Cleaner", "Guard"

  // Status
  isActive        Boolean     @default(true)

  // Relations
  timeLogs        TimeLog[]

  // Custom fields
  customFields    Json?

  // Metadata
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([subaccountId])
  @@index([email])
  @@index([phone])
  @@index([portalToken])
  @@map("worker")
}
